{% macro render_card(card, deck, card_number=None) %}
  {% set is_image = card.card_type == "image" %}
  {% set display_number = card_number if card_number is not none else card.card_id %}
  <article
    class="card card--{{ card.card_type }}{% if is_image %} card--image{% endif %}"
    data-card-id="{{ card.card_id }}"
    data-card-type="{{ card.card_type }}"
    data-card-position="{{ display_number }}"
    {% if card.card_type == "cloze" %}
      data-card-endpoint="{{ url_for('card_data', deck_id=deck.deck_id, card_id=card.card_id) }}"
    {% endif %}
    {% if is_image %}data-has-images="true"{% endif %}
  >
    <header class="card-header">
      <div class="card-header__primary">
        <span class="card-chip card-chip--primary">Card {{ display_number }}</span>
      </div>
    </header>
    <div class="card-body">
      <div class="card-inner">
        <div class="card-face question" aria-labelledby="card-question-heading-{{ card.card_id }}">
          <h4 id="card-question-heading-{{ card.card_id }}" class="sr-only">Question</h4>
          {% if card.card_type == "cloze" %}
            <p class="card-instruction cloze-instructions">
              Pause for a beat and retrieve the hidden text before you reveal the answer.
            </p>
          {% elif is_image %}
            <p class="card-instruction image-instructions">
              Study the image and describe the key idea in your own words before flipping the card.
            </p>
          {% else %}
            <p class="card-instruction retrieval-instructions">
              Try to answer the prompt out loud before revealing what's on the back.
            </p>
          {% endif %}
          <div class="content{% if card.question_revealed %} has-revealed{% endif %}">
            <div class="question-front" aria-hidden="false">{{ card.question | safe }}</div>
            {% if card.question_revealed %}
              <div class="question-revealed" aria-hidden="true">{{ card.question_revealed | safe }}</div>
            {% endif %}
          </div>
        </div>
        <div class="card-face answer" aria-labelledby="card-answer-heading-{{ card.card_id }}">
          <h4 id="card-answer-heading-{{ card.card_id }}" class="sr-only">Answer</h4>
          <p class="card-instruction answer-instructions">
            Did your response match? Summarize why this answer works to lock it in before you move on.
          </p>
          <div class="content">{{ card.answer | safe }}</div>
        </div>
      </div>
      {% if card.extra_fields %}
        <details class="extra-fields">
          <summary>Additional fields</summary>
          <dl>
            {% for value in card.extra_fields %}
              <dt>Additional field</dt>
              <dd>{{ value | safe }}</dd>
            {% endfor %}
          </dl>
        </details>
      {% endif %}
      <details class="debug-panel" data-role="debug-panel" hidden>
        <summary>Debug Information</summary>
        <div class="debug-content">
          <section class="debug-section">
            <h5>Card Metadata</h5>
            <dl class="debug-info">
              <dt>Card ID:</dt>
              <dd>{{ card.card_id }}</dd>
              <dt>Note ID:</dt>
              <dd>{{ card.note_id }}</dd>
              <dt>Deck ID:</dt>
              <dd>{{ card.deck_id }}</dd>
              <dt>Deck Name:</dt>
              <dd>{{ card.deck_name }}</dd>
              <dt>Template Ordinal:</dt>
              <dd>{{ card.template_ordinal }}</dd>
              <dt>Card Type:</dt>
              <dd>{{ card.card_type }}</dd>
            </dl>
          </section>

          <section class="debug-section">
            <h5>Raw Question HTML</h5>
            <pre class="debug-code">{{ card.question }}</pre>
          </section>

          <section class="debug-section">
            <h5>Raw Answer HTML</h5>
            <pre class="debug-code">{{ card.answer }}</pre>
          </section>

          {% if card.question_revealed %}
          <section class="debug-section">
            <h5>Question Revealed HTML</h5>
            <pre class="debug-code">{{ card.question_revealed }}</pre>
          </section>
          {% endif %}

          {% if card.card_type == "cloze" %}
          <section class="debug-section">
            <h5>Cloze Information</h5>
            <dl class="debug-info">
              <dt>Raw Question:</dt>
              <dd><pre class="debug-code">{{ card.raw_question }}</pre></dd>
              <dt>Cloze Deletions:</dt>
              <dd><pre class="debug-code">{{ card.cloze_deletions | tojson(indent=2) }}</pre></dd>
            </dl>
          </section>
          {% endif %}

          {% if card.extra_fields %}
          <section class="debug-section">
            <h5>Extra Fields ({{ card.extra_fields|length }})</h5>
            {% for value in card.extra_fields %}
              <div class="debug-field">
                <strong>Field {{ loop.index }}:</strong>
                <pre class="debug-code">{{ value }}</pre>
              </div>
            {% endfor %}
          </section>
          {% endif %}

          <section class="debug-section">
            <h5>API Data</h5>
            <p class="debug-help">Card data from: <code>{{ url_for('card_data', deck_id=deck.deck_id, card_id=card.card_id) }}</code></p>
            <button type="button" class="debug-button" data-action="fetch-card-data" data-card-id="{{ card.card_id }}" data-deck-id="{{ deck.deck_id }}">Fetch & Log JSON</button>
            <pre class="debug-json" data-role="debug-json-{{ card.card_id }}" style="display:none;"></pre>
          </section>
        </div>
      </details>
    </div>
  </article>
{% endmacro %}
