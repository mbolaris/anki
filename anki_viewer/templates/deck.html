{% extends "base.html" %}
{% import "card.html" as card_templates %}
{% block title %}{{ deck.name }} ¬∑ Anki Deck Viewer{% endblock %}
{% block content %}
  <section
    class="card-viewer"
    data-deck-id="{{ deck.deck_id }}"
    data-total-cards="{{ deck.cards|length }}"
    data-active-card-type="{{ deck.cards[0].card_type if deck.cards else '' }}"
    data-density="compact"
  >
    <header class="study-header">
      <div class="study-header__top">
        <div class="study-header__title-row">
          <a class="study-header__crumb" href="{{ url_for('index') }}" aria-label="Back to deck list">
            ‚Üê Decks
          </a>
          <span class="study-header__separator" aria-hidden="true">/</span>
          <h2 class="study-header__title">{{ deck.name }}</h2>
        </div>
        <div class="study-header__meta">
          <p class="study-header__counter" data-role="counter" data-state="{% if deck.cards %}active{% else %}empty{% endif %}" aria-live="polite">
            <span class="study-header__counter-value" data-role="counter-value">
              <span data-role="counter-current">{% if deck.cards %}1{% else %}0{% endif %}</span>
              <span aria-hidden="true">/</span>
              <span data-role="counter-total">{{ deck.cards|length }}</span>
            </span>
            <span class="study-header__counter-empty" data-role="counter-empty">All cards marked as known</span>
          </p>
          <span class="study-header__progress-text" data-role="progress-percent">
            {% if deck.cards %}0 / {{ deck.cards|length }} viewed ‚Ä¢ 0%{% else %}No cards available{% endif %}
          </span>
          <span class="study-chip" data-role="known-count" data-state="empty" aria-live="polite">Known: 0</span>
        </div>
      </div>
      <div class="study-header__controls" role="toolbar" aria-label="Study controls">
        <div class="study-controls" role="group" aria-label="Card navigation">
          <button type="button" class="toolbar-button" data-action="prev" title="Previous card (‚Üê)">
            <span class="toolbar-button__icon" aria-hidden="true">‚üµ</span>
            <span class="toolbar-button__label">Prev</span>
            <span class="toolbar-button__hint" aria-hidden="true">‚Üê</span>
          </button>
          <button type="button" class="toolbar-button" data-action="flip" title="Flip card (Space / F)">
            <span class="toolbar-button__icon" aria-hidden="true">‚§æ</span>
            <span class="toolbar-button__label">Flip</span>
            <span class="toolbar-button__hint" aria-hidden="true">Space</span>
          </button>
          <button type="button" class="toolbar-button" data-action="next" title="Next card (‚Üí)">
            <span class="toolbar-button__icon" aria-hidden="true">‚ü∂</span>
            <span class="toolbar-button__label">Next</span>
            <span class="toolbar-button__hint" aria-hidden="true">‚Üí</span>
          </button>
          <button type="button" class="toolbar-button toolbar-button--primary" data-action="mark-known" title="Mark card as known (K)">
            <span class="toolbar-button__icon" aria-hidden="true">‚úì</span>
            <span class="toolbar-button__label">Known</span>
            <span class="toolbar-button__hint" aria-hidden="true">K</span>
          </button>
        </div>
        <details class="study-overflow" role="group" aria-label="More options">
          <summary class="toolbar-button toolbar-button--ghost" aria-label="More actions">
            <span class="toolbar-button__icon" aria-hidden="true">‚ãÆ</span>
            <span class="toolbar-button__label">More</span>
          </summary>
          <div class="study-overflow__menu" role="menu">
            <button type="button" class="toolbar-button" data-action="toggle-shuffle" title="Shuffle order">
              <span class="toolbar-button__icon" aria-hidden="true">‚áã</span>
              <span class="toolbar-button__label">Shuffle</span>
            </button>
            <button type="button" class="toolbar-button" data-action="random" title="Random card (R)">
              <span class="toolbar-button__icon" aria-hidden="true">üé≤</span>
              <span class="toolbar-button__label">Random</span>
              <span class="toolbar-button__hint" aria-hidden="true">R</span>
            </button>
            <button type="button" class="toolbar-button" data-action="reset-progress" title="Reset progress">
              <span class="toolbar-button__icon" aria-hidden="true">‚Ü∫</span>
              <span class="toolbar-button__label">Reset</span>
            </button>
            <button type="button" class="toolbar-button" data-action="toggle-density" aria-pressed="true" title="Toggle density">
              <span class="toolbar-button__icon" aria-hidden="true">‚áï</span>
              <span class="toolbar-button__label">Compact</span>
            </button>
            <button
              type="button"
              class="toolbar-button"
              data-action="toggle-help"
              aria-haspopup="dialog"
              aria-expanded="false"
              title="Keyboard shortcuts (?)"
            >
              <span class="toolbar-button__icon" aria-hidden="true">?</span>
              <span class="toolbar-button__label">Shortcuts</span>
              <span class="toolbar-button__hint" aria-hidden="true">?</span>
            </button>
            <button type="button" class="toolbar-button" data-action="toggle-fullscreen" title="Enter fullscreen">
              <span class="toolbar-button__icon" aria-hidden="true">‚õ∂</span>
              <span class="toolbar-button__label">Fullscreen</span>
            </button>
          </div>
        </details>
      </div>
      <div class="study-header__progress">
        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="progress-bar__inner"></div>
        </div>
      </div>
    </header>

    <div class="study-body">
      <div class="card-stage" data-role="card-stage">
        {% if deck.cards %}
          <div class="empty-state" data-role="empty-state" hidden>
            All cards are marked as known. Reset progress to start over.
          </div>
          {% set counter = namespace(value=0) %}
          {% for card in deck.cards %}
            {% set counter.value = counter.value + 1 %}
            {{ card_templates.render_card(card, deck, counter.value) }}
          {% endfor %}
        {% else %}
          <p class="empty-state">No cards were found in this deck.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <div
    class="shortcut-overlay"
    data-role="shortcut-overlay"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
    aria-labelledby="shortcut-overlay-title"
  >
    <div class="shortcut-overlay__content" tabindex="-1">
      <header class="shortcut-overlay__header">
        <h3 id="shortcut-overlay-title">Keyboard shortcuts</h3>
        <button type="button" class="toolbar-button" data-action="close-help" aria-label="Close help">
          Close
        </button>
      </header>
      <dl class="shortcut-list">
        <div>
          <dt><kbd>Space</kbd> / <kbd>F</kbd> / Click</dt>
          <dd>Flip the current card</dd>
        </div>
        <div>
          <dt><kbd>‚Üí</kbd></dt>
          <dd>Go to the next card</dd>
        </div>
        <div>
          <dt><kbd>‚Üê</kbd></dt>
          <dd>Go to the previous card</dd>
        </div>
        <div>
          <dt><kbd>R</kbd></dt>
          <dd>Jump to a random card</dd>
        </div>
        <div>
          <dt><kbd>K</kbd></dt>
          <dd>Mark the current card as known</dd>
        </div>
        <div>
          <dt><kbd>?</kbd></dt>
          <dd>Toggle this help overlay</dd>
        </div>
        <div>
          <dt><kbd>Esc</kbd></dt>
          <dd>Close dialogs or exit fullscreen</dd>
        </div>
      </dl>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='deck.js') }}" defer></script>
{% endblock %}
