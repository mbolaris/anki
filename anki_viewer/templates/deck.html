{% extends "base.html" %}
{% import "card.html" as card_templates %}
{% block title %}{{ deck.name }} ¬∑ Anki Deck Viewer{% endblock %}
{% block body_attrs %} class="viewer-page"{% endblock %}
{% block main_class %}viewer{% endblock %}
{% block site_header %}{% endblock %}
{% block site_footer %}{% endblock %}
{% block content %}
  {% set hide_memorized_default = (not is_favorites|default(false)) %}
  {% set hide_known_default = true %}
  <section
    class="card-viewer"
    data-deck-id="{{ deck.deck_id }}"
    data-total-cards="{{ deck.cards|length }}"
    data-active-card-type="{{ deck.cards[0].card_type if deck.cards else '' }}"
    data-hide-memorized-default="{{ 'true' if hide_memorized_default else 'false' }}"
    data-hide-known-default="{{ 'true' if hide_known_default else 'false' }}"
  >
    <header class="viewer__toolbar" aria-label="Deck controls">
      <div class="viewer__toolbar-top">
        <div class="viewer__breadcrumbs">
          <a class="viewer__crumb" href="{{ url_for('index') }}" aria-label="Back to deck list">
            ‚Üê Decks
          </a>
          <span class="viewer__separator" aria-hidden="true">/</span>
          <h2 class="viewer__title{% if is_favorites %} viewer__title--favorites{% endif %}">{{ deck.name }}</h2>
        </div>
        <div class="viewer__stats">
          <p class="viewer__counter" data-role="counter" data-state="{% if deck.cards %}active{% else %}empty{% endif %}" aria-live="polite">
            <span class="viewer__counter-value" data-role="counter-value">
              <span data-role="counter-current">{% if deck.cards %}1{% else %}0{% endif %}</span>
              <span aria-hidden="true">/</span>
              <span data-role="counter-total">{{ deck.cards|length }}</span>
            </span>
            <span class="viewer__counter-empty" data-role="counter-empty">All cards marked as known</span>
          </p>
          <span class="viewer__progress-text" data-role="progress-percent">
            {% if deck.cards %}0 / {{ deck.cards|length }} viewed ‚Ä¢ 0%{% else %}No cards available{% endif %}
          </span>
          <span class="card-type-chip" data-role="card-type"{% if not deck.cards %} hidden{% endif %}>
            {% if deck.cards %}{{ deck.cards[0].card_type|title }} card{% endif %}
          </span>
        </div>
      </div>
      <div class="viewer__toolbar-controls" role="toolbar" aria-label="Card controls">
        <div class="toolbar-group" role="group" aria-label="Navigate cards">
          <button type="button" class="toolbar-button" data-action="prev" title="Previous card (‚Üê)">
            <span class="toolbar-button__icon" aria-hidden="true">‚üµ</span>
            <span class="toolbar-button__label">Prev</span>
            <span class="toolbar-button__hint" aria-hidden="true">‚Üê</span>
          </button>
          <button type="button" class="toolbar-button" data-action="next" title="Next card (‚Üí)">
            <span class="toolbar-button__icon" aria-hidden="true">‚ü∂</span>
            <span class="toolbar-button__label">Next</span>
            <span class="toolbar-button__hint" aria-hidden="true">‚Üí</span>
          </button>
          <button type="button" class="toolbar-button" data-action="flip" title="Flip card (Space / F)">
            <span class="toolbar-button__icon" aria-hidden="true">‚§æ</span>
            <span class="toolbar-button__label">Flip</span>
            <span class="toolbar-button__hint" aria-hidden="true">Space</span>
          </button>
          <button
            type="button"
            class="toolbar-toggle toggle-switch"
            data-action="toggle-shuffle"
            role="switch"
            aria-checked="false"
            aria-pressed="false"
            data-state="off"
            title="Shuffle order"
          >
            <span class="toggle-switch__track" aria-hidden="true">
              <span class="toggle-switch__thumb"></span>
            </span>
            <span class="toggle-switch__content">
              <span class="toggle-switch__label">Shuffle</span>
              <span class="toggle-switch__state" data-role="toggle-state">Off</span>
            </span>
          </button>
          <button type="button" class="toolbar-button" data-action="random" title="Random card (R)">
            <span class="toolbar-button__icon" aria-hidden="true">üé≤</span>
            <span class="toolbar-button__label">Random</span>
            <span class="toolbar-button__hint" aria-hidden="true">R</span>
          </button>
        </div>
        <div class="toolbar-group" role="group" aria-label="Progress">
          <button type="button" class="toolbar-button toolbar-button--primary" data-action="mark-known" title="Mark card as known (K)">
            <span class="toolbar-button__icon" aria-hidden="true">‚úì</span>
            <span class="toolbar-button__label">Known</span>
            <span class="toolbar-button__hint" aria-hidden="true">K</span>
          </button>
          <button
            type="button"
            class="toolbar-toggle toggle-switch"
            data-action="toggle-hide-known"
            role="switch"
            aria-checked="{{ 'true' if hide_known_default else 'false' }}"
            aria-pressed="{{ 'true' if hide_known_default else 'false' }}"
            data-state="{{ 'on' if hide_known_default else 'off' }}"
            title="{{ 'Show known cards' if hide_known_default else 'Hide known cards' }}"
          >
            <span class="toggle-switch__track" aria-hidden="true">
              <span class="toggle-switch__thumb"></span>
            </span>
            <span class="toggle-switch__content">
              <span class="toggle-switch__label">{{ 'Hide Known' if hide_known_default else 'Show Known' }}</span>
              <span class="toggle-switch__state" data-role="toggle-state">{{ 'On' if hide_known_default else 'Off' }}</span>
            </span>
          </button>
          <button
            type="button"
            class="toolbar-toggle toggle-switch"
            data-action="toggle-hide-memorized"
            role="switch"
            aria-checked="{{ 'true' if hide_memorized_default else 'false' }}"
            aria-pressed="{{ 'true' if hide_memorized_default else 'false' }}"
            data-state="{{ 'on' if hide_memorized_default else 'off' }}"
            title="{{ 'Show memorized cards' if hide_memorized_default else 'Hide memorized cards' }}"
          >
            <span class="toggle-switch__track" aria-hidden="true">
              <span class="toggle-switch__thumb"></span>
            </span>
            <span class="toggle-switch__content">
              <span class="toggle-switch__label">{{ 'Hide Memorized' if hide_memorized_default else 'Show Memorized' }}</span>
              <span class="toggle-switch__state" data-role="toggle-state">{{ 'On' if hide_memorized_default else 'Off' }}</span>
            </span>
          </button>
          <button type="button" class="toolbar-button" data-action="reset-progress" title="Reset progress">
            <span class="toolbar-button__icon" aria-hidden="true">‚Ü∫</span>
            <span class="toolbar-button__label">Reset</span>
          </button>
        </div>
        <div class="toolbar-group toolbar-group--end" role="group" aria-label="Utilities">
          <button
            type="button"
            class="toolbar-toggle toggle-switch"
            data-action="toggle-debug"
            role="switch"
            aria-checked="false"
            aria-pressed="false"
            data-state="off"
            title="Show debug information (D)"
          >
            <span class="toggle-switch__track" aria-hidden="true">
              <span class="toggle-switch__thumb"></span>
            </span>
            <span class="toggle-switch__content">
              <span class="toggle-switch__label">Debug</span>
              <span class="toggle-switch__state" data-role="toggle-state">Off</span>
            </span>
          </button>
          <button
            type="button"
            class="toolbar-button"
            data-action="toggle-help"
            aria-haspopup="dialog"
            aria-expanded="false"
            title="Keyboard shortcuts (?)"
          >
            <span class="toolbar-button__icon" aria-hidden="true">?</span>
            <span class="toolbar-button__label">Shortcuts</span>
            <span class="toolbar-button__hint" aria-hidden="true">?</span>
          </button>
          <button type="button" class="toolbar-button" data-action="toggle-fullscreen" title="Enter fullscreen">
            <span class="toolbar-button__icon" aria-hidden="true">‚õ∂</span>
            <span class="toolbar-button__label">Fullscreen</span>
          </button>
        </div>
      </div>
      <div class="viewer__progress">
        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="progress-bar__inner"></div>
        </div>
      </div>
    </header>

    <div class="viewer__content">
      <div class="viewer__stage">
        <div class="card-stage" data-role="card-stage">
          {% if deck.cards %}
            <div class="empty-state" data-role="empty-state" hidden>
              All cards are marked as known. Reset progress to start over.
            </div>
            {% set counter = namespace(value=0) %}
            {% for card in deck.cards %}
              {% set counter.value = counter.value + 1 %}
              {{ card_templates.render_card(card, deck, counter.value) }}
            {% endfor %}
          {% else %}
            <p class="empty-state">No cards were found in this deck.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <div
    class="shortcut-overlay"
    data-role="shortcut-overlay"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
    aria-labelledby="shortcut-overlay-title"
  >
    <div class="shortcut-overlay__content" tabindex="-1">
      <header class="shortcut-overlay__header">
        <h3 id="shortcut-overlay-title">Keyboard shortcuts</h3>
        <button type="button" class="toolbar-button" data-action="close-help" aria-label="Close help">
          Close
        </button>
      </header>
      <dl class="shortcut-list">
        <div>
          <dt><kbd>Space</kbd> / <kbd>F</kbd> / Click</dt>
          <dd>Flip the current card</dd>
        </div>
        <div>
          <dt><kbd>‚Üí</kbd></dt>
          <dd>Go to the next card</dd>
        </div>
        <div>
          <dt><kbd>‚Üê</kbd></dt>
          <dd>Go to the previous card</dd>
        </div>
        <div>
          <dt><kbd>R</kbd></dt>
          <dd>Jump to a random card</dd>
        </div>
        <div>
          <dt><kbd>K</kbd></dt>
          <dd>Mark the current card as known</dd>
        </div>
        <div>
          <dt><kbd>D</kbd></dt>
          <dd>Toggle debug information panel</dd>
        </div>
        <div>
          <dt><kbd>?</kbd></dt>
          <dd>Toggle this help overlay</dd>
        </div>
        <div>
          <dt><kbd>Esc</kbd></dt>
          <dd>Close dialogs or exit fullscreen</dd>
        </div>
      </dl>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='deck.js') }}" defer></script>
{% endblock %}
